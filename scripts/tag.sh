#!/usr/bin/env bash

set -aeuo pipefail

TAGGER="/tmp/buildtagger"
REPO_ROOT="."

curl -fsSL  "${BUILDTAGGER_DOWNLOAD_URL}" -o "${TAGGER}"
chmod +x "${TAGGER}"

"${TAGGER}" --parent-dir "${REPO_ROOT}"/apis --regex "(.+)/.+/.+\.go" --tag-format "(%s || all) && !ignore_autogenerated" --mode dir
"${TAGGER}" --parent-dir "${REPO_ROOT}"/apis --regex "(.+)/.+/zz_groupversion_info\.go" --tag-format "(%s || all) && !ignore_autogenerated" --mode dir
"${TAGGER}" --parent-dir "${REPO_ROOT}"/internal/controller --regex "(.+)/.+/zz_controller\.go" --tag-format "(%s || all) && !ignore_autogenerated" --mode dir
"${TAGGER}" --parent-dir "${REPO_ROOT}"/internal/controller --regex "zz_(.+)_setup\.go" --tag-format "(%s || all) && !ignore_autogenerated" --mode file
"${TAGGER}" --parent-dir "${REPO_ROOT}"/cmd/provider --regex "(.+)/zz_main\.go" --tag-format "(%s || all) && !ignore_autogenerated" --mode dir
"${TAGGER}" --parent-dir "${REPO_ROOT}"/config --regex "(.+)/config\.go" --tag-format "(%s || all) && !ignore_autogenerated" --mode dir

# constant tags
# apis/zz_register.go -> (apiregister || register || all) && !ignore_autogenerated
"${TAGGER}" --parent-dir "${REPO_ROOT}"/apis/zz_register.go --tag-format "all && !ignore_autogenerated" --mode file
# cmd/generator/main.go -> config || generate || all
"${TAGGER}" --parent-dir "${REPO_ROOT}"/cmd/generator/main.go --tag-format "all" --mode file
# config/autoscaling/config_test.go -> (autoscaling || config || all) && !ignore_autogenerated
"${TAGGER}" --parent-dir "${REPO_ROOT}"/config/autoscaling/config_test.go --tag-format "(autoscaling || all) && !ignore_autogenerated" --mode file
# config/common/apis/lambda/extractor.go -> config || lambda || all
"${TAGGER}" --parent-dir "${REPO_ROOT}"/config/common/apis/lambda/extractor.go --tag-format "lambda || all" --mode file
# config/config_registry.go -> configregistry || register || config || all
"${TAGGER}" --parent-dir "${REPO_ROOT}"/config/registry.go --tag-format "configregistry || all" --mode file
# config/provider.go -> configprovider || register || config || all
"${TAGGER}" --parent-dir "${REPO_ROOT}"/config/provider.go --tag-format "(configprovider || all) && !linter_run" --mode file
# config/overrides.go -> configprovider || register || config || all
"${TAGGER}" --parent-dir "${REPO_ROOT}"/config/overrides.go --tag-format "configprovider || all" --mode file
# internal/controller/eks/clusterauth/controller.go -> eks || all
"${TAGGER}" --parent-dir "${REPO_ROOT}"/internal/controller/eks/clusterauth/controller.go --tag-format "eks || all" --mode file
# internal/controller/eks/clusterauth/eks.go -> eks || all
"${TAGGER}" --parent-dir "${REPO_ROOT}"/internal/controller/eks/clusterauth/eks.go --tag-format "eks || all" --mode file

# linter only files
# ./.../linter_run.go -> linter_run
"${TAGGER}" --parent-dir "${REPO_ROOT}" --regex "linter_run.go" --tag-format "linter_run" --mode file